# 03 Backend Responsibility

## 核心責任
- 提供倉儲管理系統所需之資料讀取與狀態變更能力，並與既有後台資料模型/格式一致。
- 負責權限與資料隔離（依登入者內部廠區與角色）。
- 負責即時同步：任何狀態/資料變更需在 < 3 秒內推送或可被前台取得。
- 負責操作記錄與可追溯性（狀態變更、關鍵操作、資料修改）。

## 身份驗證與會話
- 登入驗證：以後台「碼頭管理 > 碼頭人員列表」作為帳號來源進行驗證。
- 驗證失敗：回傳可供前台顯示之錯誤狀態（前台文案：帳號密碼輸入錯誤）。
- 登出：提供安全登出能力並使既有會話失效。
- 會話逾時：需支援逾時自動失效（逾時時間與續期策略未定義）。

## 權限與資料隔離
- 內部廠區隔離：所有清單、查詢、狀態變更皆需限制於登入者所屬內部廠區的可見資料範圍。
- 操作權限：所有寫入操作需進行權限驗證；後台管理員可依權限同步查看/修改前台資料（權限矩陣未定義）。

## 忘記密碼提示內容
- 提供「忘記密碼」提示文字之讀取能力，內容由後台「網站管理 > 區塊內容管理 > 碼頭-忘記密碼」設定；前台僅純顯示。

## 即時公告
- 公告列表：支援依條件查詢、回傳已讀/未讀狀態。
- 已讀：支援單筆已讀、批量已讀（依前台篩選條件作用的集合）。
- 刪除：支援單筆刪除、批量刪除（依前台篩選條件作用的集合）。
- 一致性：批量操作需以同一條件定義其作用範圍，並可回傳影響筆數供前台提示。

## 出貨作業管理（碼頭/車次）

### 資料提供
- 碼頭列表：回傳所有碼頭及其當前顯示狀態（供碼頭儀錶板）。
- 未排車次列表：回傳符合登入者廠區與條件的未排車次集合（供列表與篩選）。
- 可選車次下拉候選：僅回傳符合條件者：
  - 配送日期為當天
  - 任務起點內部廠區 = 登入者內部廠區
  - 任務包含「送貨」配送單
  - 任務未完成出車且未取消
- 車次詳細資訊：回傳車次基本資訊與配送點/客戶配送單明細（供燈箱顯示）。

### 狀態與轉移規則
- 支援車輛狀態：正常、缺貨待料、通知未到、完成出車、取消。
- 終態：完成出車、取消（終態後不再出現在碼頭儀錶板與可選/未排車次清單中）。
- 非終態回退：缺貨待料、通知未到（需回到未排車次列表與可選下拉候選）。
- 任何狀態變更需驗證合法性（例如已終態不可再變更）。

### 通知責任
- 通知運務：支援由前台觸發通知送達運務 App（推播通知）。
- 通知未到：狀態設定為通知未到時，需發送通知給運務與運務部後台主管（主管對象與通知規則未定義）。

### 即時同步
- 任何碼頭狀態、車次指派、車次狀態變更、列表集合變動，需即時同步到已登入前台（< 3 秒）。

## 收貨作業管理

### 任務狀態與資料提供
- 收貨列表：回傳任務清單與下貨狀態（接貨中/回廠下貨），支援篩選與排序（先回廠下貨再接貨中，同狀態依回報時間新到舊）。
- 回廠下貨回報：接收運務 App 回報「回廠下貨」狀態，更新任務下貨狀態，並提供回報位置與時間。
- 下貨碼頭選擇：提供可選碼頭清單並自動排除已被選定為出貨/下貨之碼頭；支援寫入選定結果。

### 配送點總表與收貨明細
- 配送點總表：回傳任務內所有「收貨」配送單之配送點/客戶資訊與收貨類型（入庫分貨/越庫作業）。
- 收貨類型判斷：依配送單迄點是否與登入者內部廠區關聯為入庫分貨（由後台內部廠區編輯頁所設定之入庫分貨配送點關聯提供）；若是則為入庫分貨，否則為越庫作業。
- 收貨明細：
  - 入庫分貨：提供商品資訊與實收數量/有效日期多組資料之讀寫；允許刪除但最少保留一組。
  - 越庫作業：提供商品資訊與「實收板位/備註」及多組資料之讀寫；允許刪除但最少保留一組。
  - 備註：支援每商品一則（入庫分貨）或隨多組資料（越庫作業）保存。

### 簽名與完成鎖定
- 簽名送出：接收運務簽名資料並保存（簽名資料屬敏感資訊需保護；加密方式未定義）。
- 完成收貨：簽名送出成功後，更新任務收貨狀態為已完成。
- 鎖定規則：已完成任務需限制再次進入配送點總表與後續修改（前台對應為不可再進入）。

### 即時同步
- 收貨列表狀態、回報位置/時間、下貨碼頭選定、收貨明細修改、簽名完成等變更需即時同步（< 3 秒）。

## 退貨作業管理
- 退貨單列表：回傳退貨單號、建立日期、原配送單號、客戶簡稱、退貨類型（直退/回廠退）、狀態（未完成/已立單），支援篩選。
- 退貨單來源整合：整合運務 App 與後台產生之退貨單資料為同一可查詢集合。
- 詳細與編輯規則：
  - 未完成：允許修改退貨商品內容。
  - 已立單：僅允許查看（唯讀）。

## 後台管理（總後台）
- 码頭管理：提供碼頭列表/碼頭人員列表之管理能力（供前台登入驗證與碼頭儀錶板資料來源）。
- 退貨單列表管理：提供後台管理員查看/管理退貨單列表的能力。
- 倉儲收貨資訊查詢：提供收貨作業資訊查詢能力，並可同步查看前台資料；依權限允許修改（詳細行為未定義）。
- 內部廠區設定擴充：提供入庫分貨配送點關聯設定之保存與供前台判斷使用。

## 操作記錄、資料完整性與審計
- 狀態變更記錄：出貨/收貨/退貨之關鍵狀態轉移與操作需被記錄並可追溯。
- 資料完整性驗證：對寫入資料進行必要驗證（例如數量不得為負、必填欄位完整、多組資料最少保留一組）。

## 非功能性行為（後端）
- 延遲目標：API 95% < 300ms；即時同步可見 < 3 秒。
- 可靠性：支援重連後的狀態一致性恢復（具體恢復流程未定義）。

## 未定義/需釐清
- 推播通知失敗的重試策略、送達回報與告警行為。
- 即時同步的降級策略（例如無法即時時的替代機制）。
- 收貨明細「進入時間」的來源（前台計時 vs 後端提供開始時間）。
