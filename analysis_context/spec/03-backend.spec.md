# 03 後端責任

> 本文件僅描述後端「責任與行為」層級，不描述資料表設計、不描述框架或實作細節（如 endpoint 名稱、Controller、ORM）。

## 1) 身份驗證與資料範圍

- 依後台【碼頭管理 > 碼頭人員列表】建置資料進行登入驗證；驗證失敗時回傳可讓前端顯示「帳號密碼輸入錯誤」的結果。
- 登入成功後，依該人員設定的「內部廠區」作為資料範圍；所有需依廠區篩選的查詢與寫入皆須依此範圍過濾，確保資料隔離。
- 會話管理：支援安全登出；會話逾時時需能讓前端得知並導向登入（逾時時間與續期策略：未定義）。
- 忘記密碼：提供「碼頭-忘記密碼」內文之讀取介面，供前台燈箱純顯示（內容由後台區塊內容管理維護）。

## 2) 即時公告

- 提供公告列表查詢，支援篩選條件；回傳資料需含已讀/未讀狀態、標題、日期等欄位。
- 支援單筆/批量標記已讀、單筆/批量刪除；批量操作之範圍依前端傳入之篩選條件為準。
- 提供單筆公告詳細內容（日期、時間、標題、內容）。
- 公告資料與後台同步；前台操作需即時反映至後台（屬即時同步範疇）。

## 3) 出貨作業：狀態與資料責任

### 3.1 碼頭與未排車次資料

- 碼頭清單：依登入者所屬內部廠區，回傳【碼頭管理 > 碼頭列表】中啟用中的碼頭；所屬廠區相同之人員取得相同碼頭清單。
- 未排車次選項：依「當天配送日期、任務起點內部廠區＝登入者所屬廠區、該任務有任何一筆送貨」三項條件篩選，符合時任務狀態為「待出貨」；車次定義來自【配送點管理 > 固定路線】該路線別之車次代號。回傳格式需支援前端顯示 [車牌]([車次])(任務單號)。
- 未排車次列表篩選：支援出貨日期、班別；不顯示任務狀態為「碼頭處理中」、「配送中」、「配送異常」、「配送完成」的車輛；列表僅含符合登入者廠區且該任務有送貨之任務。

### 3.2 車輛任務狀態轉移

- 選擇車次加入碼頭後：該車輛任務狀態改為「碼頭處理中」。
- 完成出車：狀態改為「配送中」；該車次自碼頭儀錶板與未排車次列表移除。
- 取消：狀態改為「配送中」；同上移除。
- 缺貨待料：狀態改為「缺貨待料」；自碼頭儀錶板移除，但仍出現於未排車次列表。
- 通知未到：狀態改為「通知未到」；自碼頭儀錶板移除，仍出現於未排車次列表；並觸發通知給該車次配送任務之運務員及運務部主管。
- 已排車次通知：支援「發送通知給該車次配送任務的運務員」之觸發。

### 3.3 車次詳細資料

- 依所選車號提供【派車任務管理 > 配送任務】對應之配送任務資料（上班時間、司機姓名、車號車次、路線別），以及該任務內所有配送點與配送單之收送貨商品、載具等詳細資訊，供前端燈箱顯示與收合展開。

## 4) 收貨作業：狀態與資料責任

### 4.1 收貨列表與下貨狀態

- 收貨列表：僅含「任務內有收貨」之配送任務，且符合登入者內部廠區；支援篩選。
- 下貨狀態：預設「接貨中」；運務回報「回廠下貨」後更新為「回廠下貨」，並記錄回報時間與回報位置（經緯度轉地址由後端或整合服務負責）；碼頭選擇下貨碼頭後仍為「回廠下貨」，直至簽名送出後改為「下貨完成」。
- 排序規則：先回廠下貨再接貨中，同狀態依回報時間新到舊。
- 下貨碼頭選項：回傳可選碼頭時須排除該任務已選定之出貨碼頭與下貨碼頭。

### 4.2 配送點總表與收貨明細

- 配送點總表：依任務回傳所有有收貨之配送單資訊，含客戶、配送點、收貨類型（入庫分貨／越庫作業）；收貨類型於後台配送任務建立時即寫入，前台唯讀。
- 收貨狀態為「下貨完成」之任務，不可再進入配送點總表（後端需拒絕或前端依狀態隱藏入口；若前端隱藏則後端仍應依狀態校驗）。
- 收貨明細：入庫分貨／越庫作業之商品與可編輯欄位（實收數量、有效日期、實收板位、配送點、配送日期、備註等）由後端提供讀寫；多組資料新增/刪除時至少保留一組之規則由後端驗證。
- 進入時間：收貨明細進入時間由後端提供並可持續查詢更新，供前端動態顯示。

### 4.3 簽名與收貨完成

- 簽名送出：接收運務簽名資料，驗證後將該任務收貨狀態更新為「下貨完成」；並與後台【倉儲收貨管理 > 倉儲收貨資訊查詢】之處理狀態連動。
- 簽名資料需加密儲存並可追溯（審計需求）。

### 4.4 運務 APP 回廠下貨

- 接收運務 APP 回報之「回廠下貨」；更新任務狀態、記錄回報時間與位置、通知迄點同所屬廠區之碼頭人員、更新後台倉儲收貨資訊查詢與碼頭前台收貨列表狀態。

## 5) 退貨作業

- 退貨單列表：資料來源含運務 APP【異常回報-退貨】產生之退貨單、後台【碼頭管理 > 退貨單列表】之退貨單、及前後台合併「未完成」退貨單產生之彙整單；列表需依退貨類型與廠區規則過濾（直退：任務起點內部廠區＝登入者廠區；回廠退：退貨廠區＝登入者廠區）；支援關鍵字、建立日期、客戶簡稱、溫層、退貨類型、狀態篩選。
- 彙整退貨單：僅允許狀態為未完成且同客戶簡稱、同溫層之退貨單合併；單張退貨單亦可建立為彙整單；彙整單號規則 BA+yyyymmdd+00001（流水號）；彙整單類型為「彙整單」、狀態為「待立單」；被合併原退貨單狀態變為「已彙整」；需與後台退貨單列表即時同步。
- 退貨單/彙整單編輯與查看：依狀態提供可編輯或唯讀之資料與儲存行為；退貨單編輯儲存需與後台該筆資料連動；檔案上傳僅允許 PDF、PNG、JPG。
- 直退：運務 APP 選擇直退並送出後，後台產生配送單、退貨單狀態為「已立單」；相關欄位帶入規則依 PRD 規定。
- 後台新增退貨單、彙整單編輯/查看、退貨配送單建立與狀態更新（待立單→已立單）等，皆屬後端責任範圍；與前台列表與編輯頁雙向同步。

## 6) 即時同步與通知

- 即時同步：後台操作需在時限內（< 3 秒）反映至前端；前端操作需即時同步至後台與其他裝置；需維持即時雙向連線機制（如 WebSocket 或等效），具體協定與技術未定義。
- 多裝置：支援多裝置同時監控並保持資料一致。
- 網路中斷與恢復：需支援連線中斷偵測與恢復機制；離線時關鍵操作之暫存與恢復後同步策略未定義（僅知需斷線提示與恢復後同步）。
- 推播通知：發送推播至運務 APP（如已排車次通知、通知未到之運務員及運務部主管）；通知失敗時之重試次數、間隔與降級規則未定義。
- 接收運務 APP 回報：如回廠下貨狀態、簽名資料等，需即時寫入並觸發前端/後台狀態更新。

## 7) 後台管理功能（碼頭、人員、退貨單、倉儲收貨查詢）

- 碼頭管理：碼頭列表 CRUD、啟用狀態、搜尋（關鍵字、所屬廠區）；刪除僅允許未曾安排過車次之碼頭。
- 碼頭人員管理：碼頭人員列表 CRUD、啟用狀態、搜尋（姓名/帳號、所屬廠區）；刪除僅允許未曾登入過之人員；密碼儲存與驗證需符合安全規範。
- 退貨單列表（後台）：搜尋欄位與列表欄位依 PRD FR68；彙整規則、單號規則、狀態流轉與前台一致並雙向同步。
- 倉儲收貨資訊查詢：列表搜尋、排序（先狀態再回報時間）、入庫分貨/越庫作業編輯頁之讀寫與前台收貨明細連動；「是否異動」於下貨完成後若後台有修改則標記為「是」。

## 8) 後台既有功能擴增

- 區塊內容管理：新增「碼頭-忘記密碼」內文維護，供前台忘記密碼燈箱讀取。
- 通知列表：發送類型新增「全部碼頭人員」、「特定碼頭人員」；選擇特定碼頭人員時需提供可選碼頭人員清單（依【碼頭管理 > 碼頭人員列表】啟用中人員）。
- 內部廠區：新增/編輯頁新增「入庫分貨配送點」關聯設定；可選配送點來自【配送點管理 > 配送點列表】，支援多選與解除關聯。
- 配送單管理：作業類型欄位（配送作業/退貨作業）；退貨作業新增頁之欄位、選擇退貨單燈箱資料、送出驗證（同商品起迄點總和相符等）、彙整單狀態更新為已立單、退貨配送單號回寫等，皆由後端負責。

## 9) 資料整合與審計

- 與現有後台系統整合：碼頭、碼頭人員、配送任務、退貨單、配送單、公告等資料需與既有後台一致；資料格式與通訊需與現有系統一致。
- 狀態變更與操作記錄：所有狀態變更操作需記錄，可追溯；審計日誌需求存在，具體保留期限未定義。
- 資料一致性驗證：可偵測並回報與現有系統之資料不一致；驗證頻率與方式未定義。

## 10) 未定義／需釐清

- 會話逾時時間與續期策略。
- 通知推播失敗之重試次數、間隔與降級規則。
- 離線情境下之資料衝突處理規則。
- 簽名送出前是否允許空白簽名（前端驗證或後端拒絕未定義）。
