# 04 API 推導清單（依 Spec 推測）

> 本文件由 00-overview、01-routing-pages、02-frontend、03-backend 四份 spec 推導出「前端/運務 APP/後台」所需之必要 API 與即時通道，不新增規格書未提及之功能。endpoint 路徑與 HTTP 方法為建議，可依實作調整。

---

## 1) 身份驗證與資料範圍

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 登入 | 03 §1 登入驗證、01 登入頁 | `POST /auth/login` — 帳號、密碼；成功回傳 session/Token 與登入者所屬內部廠區；失敗可讓前端顯示「帳號密碼輸入錯誤」 |
| 登出 | 03 §1 安全登出 | `POST /auth/logout` — 使會話失效 |
| 會話檢查/續期 | 03 §1 會話逾時、前端得知並導向登入 | `GET /auth/session` 或透過 Token 驗證中介層 — 逾時時回傳 401，前端導向登入 |
| 忘記密碼內文 | 03 §1、01 登入頁忘記密碼燈箱 | `GET /content/dock-forgot-password` — 回傳「碼頭-忘記密碼」純文字/HTML，供燈箱顯示 |

---

## 2) 即時公告

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 公告列表（含篩選） | 02 §3.1、03 §2 | `GET /announcements` — 查詢參數：篩選條件；回傳含已讀/未讀、標題、日期等，且依登入者廠區過濾 |
| 公告詳細 | 02 §3.2、03 §2 | `GET /announcements/{id}` — 回傳日期、時間、標題、內容 |
| 單筆/批量已讀 | 02 §3.1、03 §2 | `PATCH /announcements/read` — 單筆 id 或依篩選條件批量標記已讀 |
| 單筆/批量刪除 | 02 §3.1、03 §2 | `DELETE /announcements` — 單筆 id 或依篩選條件批量刪除 |

---

## 3) 出貨作業

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 碼頭清單 | 02 §4.2、03 §3.1 | `GET /docks` — 依登入者廠區回傳啟用中的碼頭（碼頭儀錶板用） |
| 未排車次選項（下拉） | 02 §4.2、03 §3.1 | `GET /shipping/unassigned-trips` — 查詢參數：出貨日期、班別；回傳格式支援 [車牌]([車次])(任務單號)，條件：當天、任務起點廠區＝登入者廠區、有送貨、狀態為待出貨 |
| 未排車次列表 | 02 §4.5、03 §3.1 | `GET /shipping/unassigned-list` — 查詢參數：出貨日期、班別；排除碼頭處理中/配送中/配送異常/配送完成，含狀態供前端著色（待出貨/缺貨待料/通知未到） |
| 選擇車次綁定碼頭 | 03 §3.2 | `POST /shipping/docks/{dockId}/assign` 或 `PATCH /shipping/trips/{tripId}/dock` — 將車次綁定至碼頭，車輛任務狀態→「碼頭處理中」 |
| 發送已排車次通知 | 02 §4.2、03 §3.2 | `POST /shipping/trips/{tripId}/notify-driver` — 通知該車次運務員前往碼頭 |
| 車次詳細（燈箱） | 02 §4.4、03 §3.3 | `GET /shipping/trips/{tripId}/detail` — 上班時間、司機、車號車次、路線別、配送點與配送單明細（可收合結構） |
| 車輛任務狀態變更 | 02 §4.4、03 §3.2 | `PATCH /shipping/trips/{tripId}/status` — body：完成出車 / 缺貨待料 / 通知未到 / 取消；依狀態自碼頭儀錶板/未排車次列表移除或保留，「通知未到」時後端觸發推播 |

---

## 4) 收貨作業

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 收貨列表 | 02 §5.1、03 §4.1 | `GET /receiving/tasks` — 查詢參數：篩選；僅含有收貨且符合登入者廠區之任務；回傳下貨狀態、回報時間/位置、可選下貨碼頭等 |
| 選擇下貨碼頭 | 02 §5.1、03 §4.1 | `PATCH /receiving/tasks/{taskId}/unload-dock` — body：下貨碼頭 id；後端排除已選出貨/下貨碼頭後驗證 |
| 配送點總表 | 02 §5.2、03 §4.2 | `GET /receiving/tasks/{taskId}/delivery-points` — 該任務所有有收貨之配送單，依客戶/配送點分類，含收貨類型（入庫分貨/越庫作業）；下貨完成之任務可拒絕或唯讀 |
| 收貨明細（入庫分貨） | 02 §5.4、03 §4.2 | `GET /receiving/delivery-points/{deliveryPointId}/detail` — 入庫分貨商品與可編輯欄位；`PATCH /receiving/delivery-points/{id}/detail` — 寫入實收數量、有效日期、備註，多組至少保留一組由後端驗證 |
| 收貨明細（越庫作業） | 02 §5.4、03 §4.2 | 同上 GET/PATCH，可編輯欄位為實收板位、配送點、配送日期、備註 |
| 進入時間 | 02 §5.4、03 §4.2 | 可併入上述 detail GET 或 `GET /receiving/delivery-points/{id}/entry-time` — 供前端動態更新顯示 |
| 簽名送出、收貨完成 | 02 §5.2–5.3、03 §4.3 | `POST /receiving/tasks/{taskId}/complete` — body：簽名資料（加密）；驗證後狀態→下貨完成、與倉儲收貨資訊查詢連動、審計紀錄 |

**運務 APP 回報（後端對外/整合）**

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 回廠下貨 | 03 §4.4 | `POST /receiving/tasks/{taskId}/report-arrival` — 運務 APP 回報回廠下貨；後端更新狀態、記錄時間與位置、通知迄點廠區碼頭人員、更新收貨列表與倉儲收貨查詢 |

---

## 5) 退貨作業

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 退貨單列表 | 02 §6.1、03 §5 | `GET /returns` — 查詢參數：關鍵字、建立日期、客戶、溫層、退貨類型、狀態；依直退/回廠退與登入者廠區過濾 |
| 彙整退貨單 | 02 §6.1、03 §5 | `POST /returns/consolidate` — body：退貨單 id 清單；僅允許未完成且同客戶簡稱、同溫層；回傳彙整單號（BA+yyyymmdd+流水號）、狀態待立單 |
| 退貨單詳情/編輯/儲存 | 01 退貨單編輯頁、03 §5 | `GET /returns/{id}`；`PUT /returns/{id}` — 狀態未完成可編輯（數量、備註、商品新增刪除、檔案上傳）；檔案限 PDF/PNG/JPG |
| 彙整單詳情/編輯/儲存 | 01 彙整單編輯頁、03 §5 | `GET /returns/consolidated/{id}`；`PUT /returns/consolidated/{id}` — 狀態待立單可編輯，規則同退貨單 |
| 退貨單/彙整單查看 | 01 退貨單查看頁、彙整單查看頁 | 同上 GET，依狀態回傳唯讀或可編輯語意 |
| 檔案上傳 | 03 §5 | `POST /returns/{id}/attachments` 或併入 PUT — 上傳退貨相關檔案 |

---

## 6) 即時同步與通知

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 即時同步 | 03 §6、02 §7 | 需**即時雙向通道**（如 WebSocket 或等效）：後台/多裝置操作在時限內（< 3 秒）推送到前端；前端操作即時寫入並廣播；具體協定與 endpoint 未在 spec 定義，實作時需提供連線、訂閱範圍（依廠區/模組）、斷線與恢復 |
| 推播至運務 APP | 03 §6、§3.2 | 後端內部/整合行為：已排車次通知、通知未到（運務員+主管）；非前台 REST API，但需預留觸發點（如與狀態變更 API 或 event 整合） |
| 運務 APP 回報 | 03 §4.4、§4.3 | 見「收貨作業」：回廠下貨、簽名送出；可為 REST `POST` 或經由同一即時通道之訊息 |

---

## 7) 後台管理（碼頭、人員、退貨、倉儲收貨）

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 碼頭 CRUD | 01 碼頭列表/新增編輯、03 §7 | `GET /admin/docks`（搜尋：關鍵字、廠區）；`POST /admin/docks`；`GET /admin/docks/{id}`；`PUT /admin/docks/{id}`；`DELETE /admin/docks/{id}`（僅允許未曾安排車次） |
| 碼頭人員 CRUD | 01 碼頭人員列表/新增編輯、03 §7 | `GET /admin/dock-personnel`（搜尋：姓名/帳號、廠區）；`POST /admin/dock-personnel`；`GET /admin/dock-personnel/{id}`；`PUT /admin/dock-personnel/{id}`；`DELETE /admin/dock-personnel/{id}`（僅允許未曾登入）；密碼儲存與驗證符合安全規範 |
| 退貨單列表（後台） | 01 退貨單列表各子頁、03 §5、§7 | `GET /admin/returns` — 搜尋欄位同 PRD FR68；列表與彙整/編輯/查看與前台雙向同步 |
| 倉儲收貨資訊查詢 | 01 倉儲收貨資訊查詢、03 §7 | `GET /admin/warehouse-receiving` — 列表搜尋、排序（先狀態再回報時間）；`GET /admin/warehouse-receiving/{taskId}/inbound`、`PUT ...`（入庫分貨）；`GET /admin/warehouse-receiving/{taskId}/cross-dock`、`PUT ...`（越庫）；與前台收貨明細連動，「是否異動」於下貨完成後若後台有修改則為「是」 |

---

## 8) 後台既有功能擴增（內容、通知、廠區、配送單）

| 用途 | 推導依據 | 建議 API / 行為 |
|------|----------|------------------|
| 碼頭-忘記密碼內文維護 | 03 §8、01 區塊內容管理 | 後台：`GET/PUT /admin/content/dock-forgot-password` 或併入既有區塊內容 API；前台讀取見 §1 |
| 通知列表發送類型、碼頭人員 | 03 §8、01 通知列表 | 後台：通知發送類型新增「全部碼頭人員/特定碼頭人員」；`GET /admin/dock-personnel` 或專用 `GET /admin/notifications/eligible-dock-personnel` — 啟用中碼頭人員供燈箱選擇 |
| 內部廠區入庫分貨配送點 | 03 §8、01 配送點管理 | 後台：內部廠區新增/編輯頁之「入庫分貨配送點」關聯；`GET /admin/sites/{id}/inbound-delivery-points`、`PUT /admin/sites/{id}/inbound-delivery-points` — 可選配送點來自配送點列表，多選與解除 |
| 配送單管理擴增 | 03 §8、01 配送單管理 | 後台：作業類型（配送/退貨）、退貨作業新增欄位、選擇退貨單燈箱、送出驗證、彙整單→已立單、退貨配送單號回寫等；依既有配送單 API 擴充或新增 `POST /admin/delivery-orders/return` 等 |

---

## 9) 資料整合與審計（無額外對外 API 需求）

- 與既有後台整合、狀態變更與操作記錄、資料一致性驗證均為後端內部或排程責任；若需「不一致回報」可為監控/日誌或管理員用 `GET /admin/audit-logs`、`GET /admin/data-consistency-report` 等，spec 未定義則視實作需求再補。

---

## 對照摘要

| 模組 | 主要 API 群 | 即時/推播 |
|------|-------------|-----------|
| 身份驗證 | login, logout, session, GET 忘記密碼內文 | — |
| 即時公告 | 列表、詳細、已讀、刪除（單筆/批量） | 同步至後台（依 §6 通道） |
| 出貨作業 | 碼頭清單、未排車次選項/列表、綁定碼頭、通知、車次詳細、狀態變更 | 狀態變更即時反映；推播至運務 APP |
| 收貨作業 | 收貨列表、下貨碼頭、配送點總表、收貨明細 CRUD、簽名完成；運務回廠下貨 | 即時同步；運務回報寫入並通知 |
| 退貨作業 | 列表、彙整、退貨單/彙整單 CRUD、附件上傳 | 與後台雙向同步 |
| 後台管理 | 碼頭、碼頭人員、退貨單、倉儲收貨查詢 CRUD；內容/通知/廠區/配送單擴增 | 與前台同步 |
| 共通 | — | WebSocket 或等效即時雙向通道、斷線與恢復 |

以上為依現有 spec **推測之必要 API**，實作時可合併或拆分 endpoint、調整 REST 資源命名與 HTTP 方法以符合既有後台慣例。
